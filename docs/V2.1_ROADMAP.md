# v2.1 Implementation Roadmap

## Current Status: v2.0 DEPLOYED ✅
- .xls file anonymization working
- Enhanced batch reports with:
  - Anonymization Mappings sheet
  - Copied Files sheet
  - All bug fixes deployed

## v2.1 Goals

### 1. PERFORMANCE OPTIMIZATION (CRITICAL)
**Problem:** 10-Q files take 4+ minutes to process
**Root Cause:** 367 separate regex passes per text element = ~1.8M operations for large docs
**Solution:** Combine all patterns into ONE regex = ~5K operations (367x faster)

**Implementation:**
- Modify `precompile_patterns()` in process_adobe_word_files.py
- Create combined regex pattern: `(pattern1|pattern2|...|pattern367)`
- Update anonymize_text() to use single-pass matching
- Apply same optimization to PowerPoint and Excel processors

**Files to modify:**
1. `process_adobe_word_files.py` - precompile_patterns(), anonymize_text()
2. `process_powerpoint.py` - anonymize_text_pptx()
3. `process_excel.py` - anonymize_text_xlsx()

**Testing:** Re-run Quantiva batch - should complete in ~1 minute instead of 6 minutes

### 2. DETAILED REPLACEMENT TRACKING
**Goal:** Report sheet showing which specific replacements were made in each document

**Example output:**
```
Document: IPO_Filing.docx
  Netflix → Nautilus: 45 occurrences
  Reed Hastings → [DELETED]: 3 occurrences
  Los Gatos → Redwood City: 12 occurrences
```

**Implementation:**
1. Modify anonymization functions to track details:
   - `anonymize_text()` - Add `track_details` parameter, return `replacement_details` dict
   - `anonymize_text_pptx()` - Same
   - `anonymize_text_xlsx()` - Same

2. Update aggregation functions:
   - `anonymize_docx()` - Aggregate details from all text elements
   - `anonymize_pptx()` - Same
   - `anonymize_xlsx()` - Same
   - `process_single_xls()` - Same

3. Update process_single functions to return details:
   - `process_single_docx()` - Return (replacements, images, details)
   - `process_single_pptx()` - Return (replacements, images, details)
   - `process_single_xlsx()` - Return (replacements, 0, details)
   - `process_single_xls()` - Return (replacements, 0, details)

4. Update BatchStats:
   - Add `file_replacement_details` list
   - Modify `add_file_result()` to accept `replacement_details` parameter
   - Store: `{'file_path': ..., 'details': {original: count, ...}}`

5. Update batch_anonymize.py process_file:
   - Handle new return format from process_single functions
   - Pass details to BatchStats

6. Add report sheet in generate_excel_report():
   - Sheet 7: "Detailed Replacements by Document"
   - Columns: File Path | Directory | Document | Original | Replacement | Occurrences | Action Type
   - Sort by document, then by occurrence count (desc)

**Files to modify:**
1. `process_adobe_word_files.py`
2. `process_powerpoint.py`
3. `process_excel.py`
4. `batch_anonymize.py`

## Estimated Effort
- Performance optimization: 30 minutes
- Detailed tracking: 2 hours
- Testing: 30 minutes
- **Total: ~3 hours**

## Testing Plan
1. Run Quantiva batch with v2.1
2. Verify speed improvement (should be 5-10x faster)
3. Check new report sheet has detailed replacements
4. Spot check accuracy of tracking

## Notes
- All changes are BACKWARD COMPATIBLE
- Existing code continues to work
- New features are additive only
- Safe to deploy incrementally
